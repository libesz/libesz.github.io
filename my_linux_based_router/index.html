<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>My Linux based router | Archive of libesz-s piece on the web</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="My Linux based router" /><meta name="author" content="Gergo Huszty" /><meta property="og:locale" content="en_US" /><meta name="description" content="Some idea in the “how to build a home server with cheap and low power consuming hardware” topic :)" /><meta property="og:description" content="Some idea in the “how to build a home server with cheap and low power consuming hardware” topic :)" /><link rel="canonical" href="https://libesz.github.io/my_linux_based_router/" /><meta property="og:url" content="https://libesz.github.io/my_linux_based_router/" /><meta property="og:site_name" content="Archive of libesz-s piece on the web" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2010-01-06T02:27:15+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="My Linux based router" /><meta name="twitter:site" content="@gergo_huszty" /><meta name="twitter:creator" content="@Gergo Huszty" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Some idea in the “how to build a home server with cheap and low power consuming hardware” topic :)","author":{"@type":"Person","name":"Gergo Huszty"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://libesz.github.io/my_linux_based_router/"},"@type":"BlogPosting","url":"https://libesz.github.io/my_linux_based_router/","headline":"My Linux based router","dateModified":"2010-01-06T02:27:15+01:00","datePublished":"2010-01-06T02:27:15+01:00","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/assets/js/post.min.js" async></script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Archive of libesz-s piece on the web</a></div><div class="site-subtitle font-italic">a site about my and my friends electronics and programming hobby projects</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/libesz" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/gergo_huszty" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['gergo.huszty','digitaltrip.hu'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>My Linux based router</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Refactor the HTML structure. --> <!-- Suroundding the markdown table with '<div class="table-wrapper">. and '</div>' --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>My Linux based router</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jan 6, 2010, 2:27 AM +0100" > Jan 6, 2010 <i class="unloaded">2010-01-06T02:27:15+01:00</i> </span> by <span class="author"> Gergo Huszty </span></div><div> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 5, 2020, 9:16 PM +0200" > Oct 5 <i class="unloaded">2020-10-05T21:16:13+02:00</i> </span></div></div><div class="post-content"><p>Hello,</p><p>This is my first real post, in which I will share my experiences about building my Intel Atom and Debian Linux based router (ok, not just a router), and the result itself :).<br /> I needed something:</p><ul><li>to store my stuff (movies, musics, photos, source codes etc.) locally, not on a remote server or something</li><li>to get my stuff available on the internet if needed</li><li>to download stuff to it, via bittorrent 24/7</li><li>to handle routing and firewall roles</li><li>to use less power than a desktop machine, with two ethernet cards</li></ul><p>I was thinking about some ASUS or Linksys router with USB and an USB HDD, but it is not so efficient and powerful in p2p. Then I decided to make a serverlike Linux system, with a low power consumption x86 configuration, than I can do anything what Linux supports. Of course I wanted to solve it in a small place. Ok, let’s get mini-ITX. However, VIA EPIAs are always expensive (maybe because they are for the industry), Intel had a new (in the middle of 2008) mini-ITX motherboard, called D201GLY2. This mobo had an embedded <a href="http://ark.intel.com/Product.aspx?id=33102&amp;processor=220&amp;spec-codes=SLAF2">Intel Celeron 220</a> and SATA ports, which met my needs.</p><!--more--><p>So the first hardware configuration was a bit different than the current, it was from:</p><ul><li>Intel D201GLY2A without CPU fan (it was very loud) and a replaced heatsink</li><li>1 GB DDR2 RAM</li><li>Second ethernet card in the PCI slot</li><li><a href="http://www.mini-box.com/picoPSU-90">PicuPSU 90</a> DC-DC converter</li><li>Seagate Barracuda ST3320620AS SATAII/320GB HDD</li><li>5 port TP-Link 10/100 Mb ethernet switch built-in, without it’s enclosure</li><li>12V 4A adapter</li><li>Zalman ZM-F2 92mm fan</li><li>a reused enclosure</li></ul><p>It was quite cheap and it had only one quiet fan.</p><p>I added double resistor to the fan (100Ω) to make it quiet, because I couldn’t adjust it enough down in the BIOS. Then I tried to reuse the holes on the enclosure (and drill the rest of course), because previously I wanted to make it to an amplifier (I’ve never finished it :D ). So I attached the mobo to the bottom, the fan and the HDD to the top (I haven’t got enough place on the ground for the HDD, next to the mobo), and the 5 port switch to the back. I plugged the second network card to the switch, then it has 4 LAN ports still.</p><p>Then, a year later I started to outgrow from the 320 GBytes and as I had all my important data on that single HDD, if it crashes, I lost them all (I don’t really like writing everything to DVDs). I also made a mistake with the Seagate hard drive, actually two. First was to buy it :). Seagates are very trustable and good hard drives, but this type is very loud when it writes to or reads from the disk (it hasn’t got acoustic management). It was bad to sleep in one room with the router. The second mistake was to attach it to the top of the metal enclosure, because it added an extra noise to it, even when the hard drive was idle.</p><p>So I saved up some money and decided to upgrade my system to use two HDDs in <a href="http://en.wikipedia.org/wiki/RAID">RAID1</a> to mirror my important data. I got two <a href="http://www.wdc.com/en/products/products.asp?DriveID=336">1TB WD caviar green</a> hard drive for a good price (and with half power power consumption comparing to the regular drives, with acoustic management, etc.), and a new mobo: <a href="http://www.intel.com/Products/Desktop/Motherboards/D945GCLF/D945GCLF-overview.htm">Intel D945GCLF</a>. The mobo wasn’t necessary to change, but I got it very cheap :) and it has <a href="http://ark.intel.com/Product.aspx?id=35635&amp;processor=230&amp;spec-codes=SLB6Z">Intel Atom 230</a> with<a href="http://en.wikipedia.org/wiki/Hyper-threading">hyperthreading</a>.</p><p>I made some pictures about the reconstructing :)</p><p><a href="/assets/images/2010/01/1.jpg"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/2010/01/1-300x198.jpg" alt="alter" title="hdd and it's stand" /></a>My colleague made me a little stand to get the drives attached to the bottom. The special in it is the 10mm distance what it holds on the left bottom. This is needed because when the enclosure is pieced together, it has a rail under the stand (this was in the way previously to get the hard drive to the bottom).</p><p><a href="/assets/images/2010/01/2.jpg"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/2010/01/2-300x196.jpg" alt="" title="hdd and it's stand 2" /></a>Now I got the chance to say the distances of the screws on the 3,5 “ hard drives to the whole world :D, because I coudn’t find it in any standard or blog or nowhere on the internet. So every HDD has 3 screwhole per side, the lower distance is (which is between the closest hole to the connector to the center) is 42,5 mm, the other (the bigger, from the center to the orher side) is 60 mm.</p><p><a href="/assets/images/2010/01/3.jpg"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/2010/01/3-300x229.jpg" alt="almost ready" title="almost ready" /></a>Every pieces in the house :) It has front USB as well.</p><p><a href="/assets/images/2010/01/4.jpg"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/2010/01/4-300x198.jpg" alt="" title="closed" /></a>Ready to install.</p><p><a href="/assets/images/2010/01/5.jpg"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/2010/01/5-300x224.jpg" alt="" title="the back" /></a>This is the connector side. Yes, the IO shield is still missing, I will make it there somehow. Here You can see the green UTP cable, connected to the second netword card and to the LAN switch.</p><p>So this is my current hardware configuration. My only need is to make the LAN side 1 Gigabit wide :)</p><p>Now we arrived to the software part, the really usable part of the post :) From now on, here will be some little tutorial.</p><p>The first thing was to install Debian on it. At this point I found out that, I have two already used SATA ports and I only have a SATA DVD-ROM to install, and no USB rack for it. Ok, I can install the system with one HDD, then plug the second and make the RAID mirror, but I wanted to do it at the install phase. So let’s somehow install it from flash drive (I’ve never tried this). I tried to find some tutorial about this with no luck, it’s probably my fault :), but finally I found that three lines what I needed. You only need another booted Linux machine, and follow the instructions on <a href="http://www.debian-administration.org/article/Boot_Debian_from_an_USB_device">debian-administration.org</a>. Be careful, for the latest stable version, you need to get the cd-image file from <a href="http://www.debian.org/CD/netinst/">here</a> to copy to the flash drive. Another tip for the successful boot from USB: on the G945GCLF, there is about five stupid boot option about USB, turn everything on, the last option (USB Mass Storage Emulation Type) should be: “All Fixed Disc”. Then it can boot from the flash drive. The process is the same from here, it will find the iso file on the drive, mount it as a cdrom, and start the installer…</p><h2 id="configuring-software-raid">Configuring software RAID</h2><p>during the install is pretty simple:</p><ul><li>Choose manual partitioning</li><li>When it shows the available disks, you should first create the same size partitions for the mirror</li><li>When creating, select the “Use as:” option to physical volume for RAID and don’t forget to toogle the bootable flag to “on” to the boot partition (usually / or /boot if you separate it) on both side of the RAID1</li><li>Now you can choose in the disk menu: “Configure software RAID” follow the instructions…</li><li>Once you set up the RAIDed partition(s), you can see it as a new disk, there you have to select the real “Use as:” and “Mount point:” options as usual</li></ul><p>The other difference during the installion is to select the primary network interface, which will be your WAN interface. After install is complete, you can turn off the USB things in the BIOS and set the boot order to the hard drives.</p><p>I made a 20 GB for the system and a 300 GB /home partition with RAID1 (for the irreplaceable like photos, source codes), 1+1GB swap and two other partitions without RAID for the not so important data (movies, temp data, etc) to maximise the space.</p><p>The next is:</p><h2 id="setting-up-sudo-optional">Setting up sudo (optional)</h2><p>Now login to the brand new system as root. My practice is to install sudo, and let the regular user (you created one during the installion) in the sudoers file to do everything like in Ubuntu. To do this, add this line to the /etc/sudoers file:</p><p>regular_username  ALL=(ALL) ALL</p><p>Then you can set the root password to 20 char long and forget it :) because the regular user can become root with</p><p>sudo bash</p><p>and his own password.</p><h2 id="setting-up-the-routing-itself">Setting up the routing itself</h2><p>Set up the network interfaces in /etc/network/interfaces. It should look like:</p><blockquote><p>auto lo<br /> iface lo inet loopback</p><p>#The WAN network interface<br /> allow-hotplug eth0<br /> iface eth0 inet dhcp</p><p>#The LAN network interface<br /> allow-hotplug eth1<br /> iface eth1 inet static<br /> address 192.168.1.254<br /> broadcast 192.168.1.255<br /> netmask 255.255.255.0</p></blockquote><p>I have cable modem connected to the WAN interface, due to this, eth0 just gets a simple IP from the ISP’s DHCP. If you have DSL connection, you should configure it first.</p><p>The routing rules are basically just some iptables rules, which are executed once, during boot.</p><p>If I remember correctly, I found my sample <a href="http://www.gentoo.org/doc/en/home-router-howto.xml">here</a>.</p><p>I edited it to meet my needs, and now it look’s like this:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="c">#Load kernel modules</span>

modprobe ip_conntrack_ftp

<span class="c">#First we flush our current rules</span>

iptables <span class="nt">-F</span>

iptables <span class="nt">-t</span> nat <span class="nt">-F</span>
<span class="c">#Setup default policies to handle unmatched traffic</span>

iptables <span class="nt">-P</span> INPUT ACCEPT

iptables <span class="nt">-P</span> OUTPUT ACCEPT

iptables <span class="nt">-P</span> FORWARD DROP
<span class="c">#Interfaces</span>

<span class="nb">export </span><span class="nv">LAN</span><span class="o">=</span>eth1

<span class="nb">export </span><span class="nv">WAN</span><span class="o">=</span>eth0
<span class="c">#detect WAN IP</span>

<span class="nb">export </span><span class="nv">WANIP</span><span class="o">=</span><span class="sb">`</span>ifconfig <span class="k">${</span><span class="nv">WAN</span><span class="k">}</span> | <span class="nb">grep </span>inet | <span class="nb">cut</span> <span class="nt">-d</span>: <span class="nt">-f</span> 2 | <span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f</span> 1<span class="sb">`</span>
<span class="c">#Shitlist - If you know some bad-bad guy's IP or IP range</span>

<span class="c">#iptables -A INPUT -i ${WAN} -s xxx.xxx.xxx.xxx/y -j DROP</span>
<span class="c">#Then we lock our services so they only work from the LAN</span>

iptables <span class="nt">-I</span> INPUT 1 <span class="nt">-i</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-j</span> ACCEPT

iptables <span class="nt">-I</span> INPUT 1 <span class="nt">-i</span> lo <span class="nt">-j</span> ACCEPT

iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> UDP <span class="nt">--dport</span> bootps <span class="nt">-i</span> <span class="o">!</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-j</span> REJECT

iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> UDP <span class="nt">--dport</span> domain <span class="nt">-i</span> <span class="o">!</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-j</span> REJECT

<span class="c">#Allow access to our server from the WAN</span>

<span class="c">#iptables -A INPUT -p TCP --dport ftp -i ${WAN} -j ACCEPT</span>

<span class="c">#iptables -A INPUT -p TCP --dport 17654 -i ${WAN} -j ACCEPT</span>

<span class="c">#etc.</span>

<span class="c">#Drop TCP / UDP packets to privileged ports</span>

iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> TCP <span class="nt">-i</span> <span class="o">!</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-d</span> 0/0 <span class="nt">--dport</span> 0:1023 <span class="nt">-j</span> DROP

iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> UDP <span class="nt">-i</span> <span class="o">!</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-d</span> 0/0 <span class="nt">--dport</span> 0:1023 <span class="nt">-j</span> DROP
<span class="c">#Port forwarding to the LAN machines</span>

iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-i</span> <span class="k">${</span><span class="nv">WAN</span><span class="k">}</span> <span class="nt">-p</span> tcp <span class="nt">--dport</span> 12345 <span class="nt">-j</span> DNAT <span class="nt">--to</span> 192.168.1.99:12345
<span class="c">#Finally we add the rules for NAT</span>

iptables <span class="nt">-I</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-d</span> 192.168.1.0/255.255.255.0 <span class="nt">-j</span> DROP

iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">LAN</span><span class="k">}</span> <span class="nt">-s</span> 192.168.1.0/255.255.255.0 <span class="nt">-j</span> ACCEPT

iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">WAN</span><span class="k">}</span> <span class="nt">-d</span> 192.168.1.0/255.255.255.0 <span class="nt">-j</span> ACCEPT

iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">WAN</span><span class="k">}</span> <span class="nt">-j</span> MASQUERADE
<span class="c">#DNAT 22 to 433 from some special places. It can happened that some proxy or firewall blocks the 22 port. From there you can not access your router. This is bad :) but if that firewall allows to connect trough 443 (https), and usually allows, you can specify IP ranges, from where the router accepts the connection on the TCP port 443, and forwards it to the 22 locally.</span>

<span class="c">#iptables -t nat -A PREROUTING -i ${WAN} -p tcp --source xxx.xxx.xxx.xxx/y--dport 443 -j DNAT --to ${WANIP}:22</span>

<span class="c">#Tell the kernel that ip forwarding is OK</span>

<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward

<span class="k">for </span>f <span class="k">in</span> /proc/sys/net/ipv4/conf/<span class="k">*</span>/rp_filter <span class="p">;</span> <span class="k">do </span><span class="nb">echo </span>1 <span class="o">&gt;</span> <span class="nv">$f</span> <span class="p">;</span> <span class="k">done</span>
</pre></table></code></div></div><p>You can place this file for example in /etc/init.d/router, make it executable and make a symlink for it with:</p><blockquote><p>ln -s /etc/init.d/router /etc/rc2.d/S95router</p></blockquote><p>Then it will starts everytime you boot. Now you need to install some DHCP server to share IPs on the LAN. Install dnsmasq package! This is a lightweight DHCP server and DNS proxy, which is cool because you can make it to access your router by name.</p><p>Let’s configure the new DHCP in /etc/dnsmasq.conf</p><blockquote><p>dhcp-range=192.168.1.1,192.168.1.199,72h<br /> interface=eth1</p></blockquote><p>Yes, this is enough :)</p><p>Set up your router’s dns name on the LAN by adding /etc/hosts:</p><blockquote><p>192.168.1.254   router</p></blockquote><p>Now install openssh-server package and reboot the system. If everything went well, you can connect a client to a LAN port and access the internet behind your router, access your router via ssh (instead of IP, just type “router”) and disconnect the monitor and the keyboard from the router forever :)</p><p>And now you can add any service what you want. I also added:</p><ul><li>permanent free domain name for my dynamic WAN IP</li><li><a href="http://munin-monitoring.org/">munin</a>to monitor the parameters of the system</li><li><a href="http://libtorrent.rakshasa.no/">rtorrent</a> for download (with wtorrent GUI and apache2)</li><li>samba to access every downloaded data on the clients, data can simply played on the clients without copying them, through the network</li><li>svn version control system to store my source codes, accessible over http from outside with authentication</li></ul><p>Well, thats it for first time, some more tutorials of this list will come soon. Do not hesitate to write comments if you have some question, or just found some mistake in the tutorial.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/linux/'>Linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/d945gclf/" class="post-tag no-text-decoration" >d945gclf</a> <a href="/tags/debian/" class="post-tag no-text-decoration" >debian</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/router/" class="post-tag no-text-decoration" >router</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=My Linux based router - Archive of libesz-s piece on the web&url=https://libesz.github.io/my_linux_based_router/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=My Linux based router - Archive of libesz-s piece on the web&u=https://libesz.github.io/my_linux_based_router/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=My Linux based router - Archive of libesz-s piece on the web&url=https://libesz.github.io/my_linux_based_router/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/atmega8/">atmega8</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/c%23/">C#</a> <a class="post-tag" href="/tags/toner-transfer-method/">toner transfer method</a> <a class="post-tag" href="/tags/router/">router</a> <a class="post-tag" href="/tags/ledcube/">ledcube</a> <a class="post-tag" href="/tags/led-cube/">led cube</a> <a class="post-tag" href="/tags/led/">led</a> <a class="post-tag" href="/tags/dotnet/">dotNet</a> <a class="post-tag" href="/tags/water/">water</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/hello-world/" class="btn btn-outline-primary"><p>Hello world!</p></a> <a href="/bicolor-led-matrix-with-atmega8/" class="btn btn-outline-primary"><p>Bicolor led matrix with atmega8</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/gergo_huszty">Gergo Huszty</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/atmega8/">atmega8</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/c%23/">C#</a> <a class="post-tag" href="/tags/toner-transfer-method/">toner transfer method</a> <a class="post-tag" href="/tags/router/">router</a> <a class="post-tag" href="/tags/ledcube/">ledcube</a> <a class="post-tag" href="/tags/led-cube/">led cube</a> <a class="post-tag" href="/tags/led/">led</a> <a class="post-tag" href="/tags/dotnet/">dotNet</a> <a class="post-tag" href="/tags/water/">water</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://libesz.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
